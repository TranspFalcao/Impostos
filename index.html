<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostos - Transportadora Falcão Ltda</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
    <div class="header-container">
        <img src="logo_falcao_transparente.png" alt="Logo" class="logo">
        <nav class="menu">
            <ul>
                <li class="ativo">Impostos</li>
                <li>Agenda Tributária</li>
                <li>Controle de CND</li>
            </ul>
        </nav>
    </div>
</header>
<main>
    <h1>Impostos</h1>
    <div class="filtros">
        <label>Unidade: <select id="filtroUnidade"></select></label>
        <label>Ano: <select id="filtroAno"></select></label>
        <label>Tipo: <select id="filtroTipo"></select></label>
        <button onclick="imprimirPagina()">Imprimir</button>
        <button onclick="baixarPDF()">Baixar PDF</button>
    </div>
    <canvas id="grafico" height="100"></canvas>
    <table id="tabela">
        <thead>
            <tr>
                <th>UNIDADE</th>
                <th>UF</th>
                <th>MÊS</th>
                <th>ANO</th>
                <th>TIPO</th>
                <th>VALOR</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</main>
<script>
async function carregarDados() {
    const response = await fetch('plan6_convertido.csv');
    const texto = await response.text();
    const linhas = texto.trim().split('
');
    const dados = linhas.slice(1).map(linha => {
        const [unidade, uf, mes, ano, tipo, valor] = linha.split(';');
        return { unidade, uf, mes, ano, tipo, valor: valor.replace('\-', '-') };
    });
    return dados;
}

function popularFiltros(dados) {
    const unidades = [...new Set(dados.map(d => d.unidade))];
    const anos = [...new Set(dados.map(d => d.ano))];
    const tipos = [...new Set(dados.map(d => d.tipo))];

    preencherSelect('filtroUnidade', unidades);
    preencherSelect('filtroAno', anos);
    preencherSelect('filtroTipo', tipos);
}

function preencherSelect(id, valores) {
    const select = document.getElementById(id);
    select.innerHTML = '<option value="">Todos</option>' + valores.map(v => `<option value="${v}">${v}</option>`).join('');
}

function aplicarFiltros(dados) {
    const unidade = document.getElementById('filtroUnidade').value;
    const ano = document.getElementById('filtroAno').value;
    const tipo = document.getElementById('filtroTipo').value;

    return dados.filter(d =>
        (unidade === '' || d.unidade === unidade) &&
        (ano === '' || d.ano === ano) &&
        (tipo === '' || d.tipo === tipo)
    );
}

function atualizarTabela(dados) {
    const tbody = document.querySelector('#tabela tbody');
    tbody.innerHTML = dados.map(d => `<tr><td>${d.unidade}</td><td>${d.uf}</td><td>${d.mes}</td><td>${d.ano}</td><td>${d.tipo}</td><td>${d.valor}</td></tr>`).join('');
}

function atualizarGrafico(dados) {
    const ctx = document.getElementById('grafico').getContext('2d');
    const meses = [...new Set(dados.map(d => d.mes))];
    const valores = meses.map(m => {
        return dados.filter(d => d.mes === m).reduce((sum, d) => sum + (parseFloat(d.valor.replace(',', '.')) || 0), 0);
    });
    const cores = valores.map(v => v >= 0 ? '#28a745' : '#dc3545');

    if(window.graficoInstance) window.graficoInstance.destroy();
    window.graficoInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: meses,
            datasets: [{ label: 'Valor', data: valores, backgroundColor: cores }]
        },
        options: {
            scales: { y: { beginAtZero: true } },
            plugins: {
                title: { display: true, text: 'Valores por Mês (Positivos e Negativos)' },
                tooltip: {
                    callbacks: {
                        label: ctx => `R$ ${ctx.parsed.y.toLocaleString('pt-BR')}`
                    }
                }
            }
        }
    });
}

function imprimirPagina() { window.print(); }
function baixarPDF() { alert('Função de exportar para PDF será implementada.'); }

(async function init() {
    const dados = await carregarDados();
    popularFiltros(dados);

    document.querySelectorAll('#filtroUnidade, #filtroAno, #filtroTipo').forEach(el => {
        el.addEventListener('change', () => {
            const filtrados = aplicarFiltros(dados);
            atualizarTabela(filtrados);
            atualizarGrafico(filtrados);
        });
    });

    atualizarTabela(dados);
    atualizarGrafico(dados);
})();
</script>
</body>
</html>